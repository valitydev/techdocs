# Работа с чарджбэками. Реализация

## Немного об чарджбэках

`Возвратный платёж` или `чарджбэк` (англ. `chargeback`) — возврат денег плательщика. 
Вид императивной гражданской ответственности банков и других финансовых 
организаций за факт поставки, которая возлагается на них международными 
платёжными системами.

Процедура опротестования транзакции банком-эмитентом (в целях защиты прав 
плательщика), при которой сумма платежа безакцептно списывается с получателя 
(банка-эквайера) и возвращается плательщику, после чего обязанность 
доказательства истинности транзакции возлагается на получателя. 
Технология возврата платежа используется в системах взаиморасчётов 
по пластиковым картам.

Простыми словами процедура чарджбэка это операция возврата денежных средств, 
когда не получилось оформить возврат на товар или услугу через мерчанта провайдера
или он не захотел возвращать денежные средства. По сути платежная система (VISA/MC/MIR)
выполняет роль арбитража и урегулирует спор между банком, мерчантом и покупателем.

Процедуру чарджбэка можно разбить на 3 стадии: 
- Чарджбек. Этап до подачи информации в платежную систему (попытка урегулирования спора банком)
- Пре арбитраж. Предварительная подача документов в платежную систему (еще одна попытка договорится)
- Арбитраж. Непосредственное решение спора и платежной системы

Банки стараются не доводить такие операции до платежных систем, так как во-первых 
эта операция не бесплатная, во-вторых за определенное количество чардждбэков 
на банк может быть наложен штраф или более серьезные рестрикции.

## Алгоритм работы

1. Пользователь инициирует процедуру спора
2. Аналогично возвратам (`refund`) чарджбэк тесно связан с инвойсом и платежом, 
поэтому сначала происходит поиск платежа по идентификаторам инвойса и платежа,
а затем происходит [запуск процедуры чарджбэка](https://github.com/valitydev/damsel/blob/master/proto/payment_processing.thrift#L1291)
3. Если платеж найден, то происходит создание нового чарджбэка с этапом `chargeback` 
и статусом `pending`. чарджбэк может завершиться на любом этапе и на каждом может 
иметь 4 статуса:`pending`,`accepted`,`rejected`,`cancelled`. Перевод на новый этап
или стутус производится менеджером системы вручную, поэтому система просто ожидает 
разрешения спора между мерчантом и плательщиком и ввода новых данных.

---

Далее:
- [реализация работы чарджбэков в hellgate](hg-chargeback-workflow.md)